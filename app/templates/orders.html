{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>Order Management</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">
        Create New Order
    </button>

    <!-- Display all orders -->
    <div class="row mt-4">
        {% for order in all_orders %}
        <div class="col-md-12 mb-3">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>Order #{{ order.order_id }} - {{ order.customer_name }}</h5>
                            <small class="text-muted">{{ order.date.strftime('%Y-%m-%d %H:%M') }} | Phone: {{ order.phone }} | Email: {{ order.email }}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addItemModal{{ order.order_id }}">
                                Add Item
                            </button>
                            <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editOrderModal{{ order.order_id }}">
                                Edit Order
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteOrderModal{{ order.order_id }}">
                                Delete Order
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if order.order_id in order_details and order_details[order.order_id]|length > 0 %}
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Pizza</th>
                                <th>Size</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Subtotal</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set total = namespace(value=0) %}
                            {% for detail in order_details[order.order_id] %}
                            {% set total.value = total.value + detail.subtotal %}
                            <tr>
                                <td>{{ detail.pizza_name }}</td>
                                <td>{{ detail.size }}</td>
                                <td>${{ "%.2f"|format(detail.price) }}</td>
                                <td>{{ detail.quantity }}</td>
                                <td>${{ "%.2f"|format(detail.subtotal) }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editDetailModal{{ detail.order_detail_id }}">
                                        Edit Qty
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteDetailModal{{ detail.order_detail_id }}">
                                        Remove
                                    </button>
                                </td>
                            </tr>

                            <!-- Edit Order Detail Modal -->
                            <div class="modal fade" id="editDetailModal{{ detail.order_detail_id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Edit Quantity</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form method="post" action="{{ url_for('orders.update_order_detail', order_detail_id=detail.order_detail_id) }}">
                                            <div class="modal-body">
                                                <p><strong>{{ detail.pizza_name }} ({{ detail.size }})</strong></p>
                                                <div class="mb-3">
                                                    <label for="quantity" class="form-label">Quantity</label>
                                                    <input type="number" class="form-control" name="quantity" min="1" value="{{ detail.quantity }}" required>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-warning">Update</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Order Detail Modal -->
                            <div class="modal fade" id="deleteDetailModal{{ detail.order_detail_id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Remove Item</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            Remove {{ detail.pizza_name }} ({{ detail.size }}) from this order?
                                        </div>
                                        <div class="modal-footer">
                                            <form method="post" action="{{ url_for('orders.delete_order_detail', order_detail_id=detail.order_detail_id) }}">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-danger">Remove</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <tr class="table-active">
                                <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                <td colspan="2"><strong>${{ "%.2f"|format(total.value) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">No items in this order yet. Click "Add Item" to add pizzas.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Edit Order Modal -->
            <div class="modal fade" id="editOrderModal{{ order.order_id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Order #{{ order.order_id }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form method="post" action="{{ url_for('orders.update_order', order_id=order.order_id) }}">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customer_id" class="form-label">Customer</label>
                                    <select class="form-select" name="customer_id" required>
                                        {% for customer in all_customers %}
                                        <option value="{{ customer.customer_id }}" {% if customer.customer_id == order.customer_id %}selected{% endif %}>
                                            {{ customer.name }} - {{ customer.phone }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-warning">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Delete Order Modal -->
            <div class="modal fade" id="deleteOrderModal{{ order.order_id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete Order</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to delete Order #{{ order.order_id }} for {{ order.customer_name }}? This will also delete all items in the order.
                        </div>
                        <div class="modal-footer">
                            <form method="post" action="{{ url_for('orders.delete_order', order_id=order.order_id) }}">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-danger">Delete Order</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Item to Order Modal -->
            <div class="modal fade" id="addItemModal{{ order.order_id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Item to Order #{{ order.order_id }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form method="post" action="{{ url_for('orders.add_order_detail', order_id=order.order_id) }}">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="pizza_id" class="form-label">Pizza</label>
                                    <select class="form-select" name="pizza_id" required>
                                        <option value="" selected disabled>Choose a pizza...</option>
                                        {% for pizza in all_pizzas %}
                                        <option value="{{ pizza.pizza_id }}">
                                            {{ pizza.name }} ({{ pizza.size }}) - ${{ "%.2f"|format(pizza.price) }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" name="quantity" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success">Add Item</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add New Order Modal -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOrderModalLabel">Create New Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('orders.show_orders') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="customer_id" class="form-label">Customer</label>
                        <select class="form-select" name="customer_id" required>
                            <option value="" selected disabled>Choose a customer...</option>
                            {% for customer in all_customers %}
                            <option value="{{ customer.customer_id }}">
                                {{ customer.name }} - {{ customer.phone }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <p class="text-muted">Note: After creating the order, you can add pizzas to it.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Order</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
